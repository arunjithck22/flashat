FROM node:18.17.0-alpine as build

# Set working directory
WORKDIR /app

COPY package.json .

# Copy the entire project
COPY . .

RUN npm install

ARG NEXT_PUBLIC_REACT_APP_BACKEND_URL
ENV NEXT_PUBLIC_REACT_APP_BACKEND_URL=$NEXT_PUBLIC_REACT_APP_BACKEND_URL
ARG AUTH_WEBAPP_GOOGLE_CLIENT_ID
ENV AUTH_WEBAPP_GOOGLE_CLIENT_ID=$AUTH_WEBAPP_GOOGLE_CLIENT_ID
ARG AUTH_WEBAPP_GOOGLE_CLIENT_SECRET
ENV AUTH_WEBAPP_GOOGLE_CLIENT_SECRET=$AUTH_WEBAPP_GOOGLE_CLIENT_SECRET
ARG AUTH_SECRET
ENV AUTH_SECRET=$AUTH_SECRET
ARG NEXT_PUBLIC_SECRET_KEY
ENV NEXT_PUBLIC_SECRET_KEY=$NEXT_PUBLIC_SECRET_KEY
ARG NEXT_PUBLIC_SOCKET_URL
ENV NEXT_PUBLIC_SOCKET_URL=$NEXT_PUBLIC_SOCKET_URL
ARG NEXT_PUBLIC_S3_BUCKET_ENV
ENV NEXT_PUBLIC_S3_BUCKET_ENV=$NEXT_PUBLIC_S3_BUCKET_ENV
ARG NEXT_PUBLIC_AWS_S3_CONFIG_URL
ENV NEXT_PUBLIC_AWS_S3_CONFIG_URL=$NEXT_PUBLIC_AWS_S3_CONFIG_URL
ARG NEXT_PUBLIC_AGORA_APP_ID
ENV NEXT_PUBLIC_AGORA_APP_ID=$NEXT_PUBLIC_AGORA_APP_ID
ARG NEXT_PUBLIC_STRIPE_SECRET_KEY
ENV NEXT_PUBLIC_STRIPE_SECRET_KEY=$NEXT_PUBLIC_STRIPE_SECRET_KEY
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_FRONTEND_URL
ENV NEXT_PUBLIC_FRONTEND_URL=$NEXT_PUBLIC_FRONTEND_URL


# Set memory limit for Node.js build
ENV NODE_OPTIONS="--max-old-space-size=2048"

# Build Next.js app
RUN npm run build

# Expose Next.js default port
EXPOSE 3000

# Start the Next.js server
CMD ["npm", "run", "start"]